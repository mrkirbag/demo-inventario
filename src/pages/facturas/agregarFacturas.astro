---
import Layout from '../../layouts/Layout.astro';
import { verificarToken } from '../../utils/auth.js';

const usuario = verificarToken(Astro.request);
if (!usuario) {
    return Astro.redirect('/login');
}
if (usuario.rol !== 'admin') {
    return Astro.redirect('/'); 
}

const fechaVenezuela = new Intl.DateTimeFormat('es-VE', {
        timeZone: 'America/Caracas',
        year: 'numeric',
        month: '2-digit',
        day: '2-digit'
    }).format(new Date());

// Convertir de formato DD/MM/YYYY a YYYY-MM-DD
const [dia, mes, ano] = fechaVenezuela.split('/');
const fechaCompleta = `${ano}-${mes}-${dia}`;
---

<Layout>
    <h1>Agregar Factura</h1>

    <div class="btn-add_container">
        <a class="btn-add" href="/facturas">Regresar</a>
    </div>

    <section class="form-container">
        <form id="formulario">
            <div>
                <input type="date" name="fecha" id="fecha" value={fechaCompleta} />
            </div>
            <div>
                <input type="text" name="proveedor" id="proveedor" placeholder="Nombre del proveedor" />
            </div>
            <div>
                <input type="text" name="monto" id="monto" placeholder="Monto de la factura" />
            </div>
            <button type="submit">Agregar</button>
        </form>
    </section>

    <div id="mensaje"></div>
</Layout>

<script type="module">

    import { mostrarError, mostrarMensaje } from '/mensajes.js';

    const formulario = document.getElementById('formulario');

    formulario.addEventListener('submit', async (event) => { 
        
        event.preventDefault();

        const fecha = document.getElementById('fecha').value;
        const proveedor = document.getElementById('proveedor').value;
        const monto = document.getElementById('monto').value;

        const raw = monto.trim().replace(',', '.');
        const montoNumero = parseFloat(raw).toFixed(2);

        // Validar campos vacios
        if (fecha === '' || proveedor === '' || monto === '' ) {
            mostrarError('Todos los campos son obligatorios.'); 
            return;
        }

        // Validar monto
        if (!montoNumero || isNaN(montoNumero) || montoNumero <= 0) {
            mostrarError('Debe ingresar un monto vÃ¡lido mayor a cero.');
            return;
        }

        try{
            const response = await fetch("/api/facturas", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ fecha, proveedor, montoNumero })
            });

            if(!response.ok){
                throw new Error('Error al agregar factura: ' + response.status);
            } else {
                mostrarMensaje('Factura agregada exitosamente.');
                setTimeout(() => {
                    window.location.href = '/facturas';
                }, 1000);
            }

        } catch(error){
            console.error(error);
        }
    });